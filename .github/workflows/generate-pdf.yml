name: Build site (prerender + CV)

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps
        run: npm ci || npm i

      # Pre-render static pages + sitemaps + robots
      - name: Pre-render site
        run: npm run build
        # package.json should contain: "build": "node prerender.js"

      # Generate CV (Puppeteer)
      - name: Install Puppeteer (if not listed)
        run: npm i puppeteer
      - name: Generate Akwasi_CV.pdf
        run: node generate-cv.js

      - name: Debug files
        run: |
          ls -la
          git status

      - name: Commit & push generated files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "chore: prerender + sitemaps + robots + CV [skip ci]" || echo "No changes to commit"
          git push || echo "Nothing to push"
